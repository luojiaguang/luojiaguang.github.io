<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>vanity_fair_01_thackeray_64kb - HTML5 Audio Read</title>
        <meta name="viewport" content="width=device-width" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<style>

html {
    background: #333;
    font-family: Verdana, sans-serif;
}
body {
    background: white;
    padding: 1em;
    border-radius: 1em;
}
a {
    color: #0E2560;
}
h2 {
    margin-bottom: 1em;
}
.passage-audio {
    height: 2em;
}
#passage-audio {
    width: 100%;
    max-height: 2em;
}
#passage-text.speaking {
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.autofocus-current-word,
.playback-rate {
    font-size: smaller;
}
.autofocus-current-word label,
.playback-rate label {
    font-weight: bold;
}
q {
    quotes: "“" "”" "‘" "’";
}
.section-heading {
    display: none;
}
.passage p {
    line-height: 1.4em;
}
.verse-start {
    line-height: 0;
}
.initialized span[data-begin]:focus,
.initialized span[data-begin]:hover {
    background-color: #FFFFCA;
    box-shadow: 0px 0px 4px #FFFFCA;
}
.initialized span[data-begin].speaking {
    background-color: yellow;
    box-shadow: 0px 0px 4px yellow;
}
.initialized span[data-begin] {
    cursor: pointer;
}
.error {
    color: red;
}

article > footer {
    border-top: solid 1px gray;
    padding-top: 1em;
    margin-top: 1em;
}

footer {
    margin-bottom: 0.5em;
    line-height: 1.4em;
    font-size: small;
}
footer img {
    vertical-align: text-bottom;
}
</style>
    </head>
    <body>
        <h1>vanity_fair_01_thackeray_64kb</h1>

        <article>
            <p class="loading">
                <em><img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==" alt="Initializing audio"> Loading audio…</em>
            </p>

            <p class="passage-audio" hidden>
                <audio id="passage-audio" class="passage" controls>
                    <source src="vanity_fair_01_thackeray_64kb.mp3" type="audio/mp3" />
                    <em class="error"><strong>Error:</strong> Your browser doesn't appear to support HTML5 Audio.</em>
                </audio>
            </p>
            <p class="passage-audio-unavailable" hidden>
                <em class="error"><strong>Error:</strong> You will not be able to do the read-along audio because your browser is not able to play MP3, Ogg, or WAV audio formats.</em>
            </p>

            <p class="playback-rate" hidden title="Note that increaseing the reading rate will decrease accuracy of word highlights">
                <label for="playback-rate">Reading rate:</label>
                <input id="playback-rate" type="range" min="0.5" max="2.0" value="1.0" step="0.1" disabled onchange='this.nextElementSibling.textContent = String(Math.round(this.valueAsNumber * 10) / 10) + "\u00D7";'>
                <output>1&times;</output>
            </p>
            <p class="playback-rate-unavailable" hidden>
                <em>(It seems your browser does not support <code>HTMLMediaElement.playbackRate</code>, so you will not be able to change the speech rate.)</em>
            </p>
            <p class="autofocus-current-word" hidden>
                <input type="checkbox" id="autofocus-current-word" checked>
                <label for="autofocus-current-word">Auto-focus/auto-scroll</label>
            </p>

            <noscript>
                <p class="error"><em><strong>Notice:</strong> You must have JavaScript enabled/available to try this HTML5 Audio read along.</em></p>
            </noscript>

            <div id="passage-text" class="passage">
                <h3 class="section-heading">vanity_fair_01_thackeray_64kb</h3>
                <p>﻿<span data-begin="0.000" data-dur="6.120">Vanity Fair</span></p><p><span data-begin="6.120" data-dur="5.600">by</span></p><p><span data-begin="11.760" data-dur="3.360">William Makepeace Thackeray</span></p><p><span data-begin="15.120" data-dur="3.640">BEFORE THE CURTAIN</span></p><p><span data-begin="18.800" data-dur="2.240">CHAPTER I</span></p><p>
<span data-begin="21.160" data-dur="1.320">Chiswick Mall</span></p><p>
<span data-begin="23.240" data-dur="55.560">While the present century was in its teens, and on one sunshiny morning in June, there drove up to the great iron gate of Miss Pinkerton's academy for young ladies, on Chiswick Mall, a large family coach, with two fat horses in blazing harness, driven by a fat coachman in a three-cornered hat and wig, at the rate of four miles an hour. A black servant, who reposed on the box beside the fat coachman, uncurled his bandy legs as soon as the equipage drew up opposite Miss Pinkerton's shining brass plate, and as he pulled the bell at least a score of young heads were seen peering out of the narrow windows of the stately old brick house. Nay, the acute observer might have recognized the little red nose of good-natured Miss Jemima Pinkerton herself, rising over some geranium pots in the window of that lady's own drawing-room</span>.</p><p>"<span data-begin="78.800" data-dur="10.000">It is Mrs. Sedley's coach, sister," said Miss Jemima. "Sambo, the black servant, has just rung the bell; and the coachman has a new red waistcoat</span>."</p><p>"<span data-begin="88.800" data-dur="18.320">Have you completed all the necessary preparations incident to Miss Sedley's departure, Miss Jemima?" asked Miss Pinkerton herself, that majestic lady; the Semiramis of Hammersmith, the friend of Doctor Johnson, the correspondent of Mrs. Chapone herself</span>.</p><p>"<span data-begin="107.120" data-dur="8.120">The girls were up at four this morning, packing her trunks, sister," replied Miss Jemima; "we have made her a bow-pot</span>."</p><p>"<span data-begin="115.240" data-dur="5.120">Say a bouquet, sister Jemima, 'tis more genteel</span>."</p><p>"<span data-begin="120.360" data-dur="10.000">Well, a booky as big almost as a haystack; I have put up two bottles of the gillyflower water for Mrs. Sedley, and the receipt for making it, in Amelia's box</span>."</p><p>"<span data-begin="130.360" data-dur="19.400">And I trust, Miss Jemima, you have made a copy of Miss Sedley's account. This is it, is it? Very good—ninety-three pounds, four shillings. Be kind enough to address it to John Sedley, Esquire, and to seal this billet which I have written to his lady</span>."</p><p><span data-begin="149.760" data-dur="34.320">In Miss Jemima's eyes an autograph letter of her sister, Miss Pinkerton, was an object of as deep veneration as would have been a letter from a sovereign. Only when her pupils quitted the establishment, or when they were about to be married, and once, when poor Miss Birch died of the scarlet fever, was Miss Pinkerton known to write personally to the parents of her pupils; and it was Jemima's opinion that if anything could console Mrs. Birch for her daughter's loss, it would be that pious and eloquent composition in which Miss Pinkerton announced the event</span>.</p><p><span data-begin="184.120" data-dur="5.880">In the present instance Miss Pinkerton's "billet" was to the following effect</span>:—</p><p><span data-begin="190.000" data-dur="3.160">The Mall, Chiswick, June 15, 18</span></p><p><span data-begin="194.800" data-dur="36.480">MADAM,—After her six years' residence at the Mall, I have the honour and happiness of presenting Miss Amelia Sedley to her parents, as a young lady not unworthy to occupy a fitting position in their polished and refined circle. Those virtues which characterize the young English gentlewoman, those accomplishments which become her birth and station, will not be found wanting in the amiable Miss Sedley, whose INDUSTRY and OBEDIENCE have endeared her to her instructors, and whose delightful sweetness of temper has charmed her AGED and her YOUTHFUL companions</span>.</p><p><span data-begin="231.320" data-dur="29.120">In music, in dancing, in orthography, in every variety of embroidery and needlework, she will be found to have realized her friends' fondest wishes. In geography there is still much to be desired; and a careful and undeviating use of the backboard, for four hours daily during the next three years, is recommended as necessary to the acquirement of that dignified DEPORTMENT AND CARRIAGE, so requisite for every young lady of FASHION</span>.</p><p><span data-begin="260.440" data-dur="22.600">In the principles of religion and morality, Miss Sedley will be found worthy of an establishment which has been honoured by the presence of THE GREAT LEXICOGRAPHER, and the patronage of the admirable Mrs. Chapone. In leaving the Mall, Miss Amelia carries with her the hearts of her companions, and the affectionate regards of her mistress, who has the honour to subscribe herself</span>,</p><p><span data-begin="283.040" data-dur="4.600">Madam, Your most obliged humble servant, BARBARA PINKERTON</span></p><p><span data-begin="287.640" data-dur="16.800">P.S.—Miss Sharp accompanies Miss Sedley. It is particularly requested that Miss Sharp's stay in Russell Square may not exceed ten days. The family of distinction with whom she is engaged, desire to avail themselves of her services as soon as possible</span>.</p><p></p><p></p><p><span data-begin="304.440" data-dur="34.760">This letter completed, Miss Pinkerton proceeded to write her own name, and Miss Sedley's, in the fly-leaf of a Johnson's Dictionary—the interesting work which she invariably presented to her scholars, on their departure from the Mall. On the cover was inserted a copy of "Lines addressed to a young lady on quitting Miss Pinkerton's school, at the Mall; by the late revered Doctor Samuel Johnson." In fact, the Lexicographer's name was always on the lips of this majestic woman, and a visit he had paid to her was the cause of her reputation and her fortune</span>.</p><p><span data-begin="340.240" data-dur="18.320">Being commanded by her elder sister to get "the Dictionary" from the cupboard, Miss Jemima had extracted two copies of the book from the receptacle in question. When Miss Pinkerton had finished the inscription in the first, Jemima, with rather a dubious and timid air, handed her the second</span>.</p><p>"<span data-begin="358.560" data-dur="6.160">For whom is this, Miss Jemima?" said Miss Pinkerton, with awful coldness</span>.</p><p>"<span data-begin="364.720" data-dur="11.520">For Becky Sharp," answered Jemima, trembling very much, and blushing over her withered face and neck, as she turned her back on her sister. "For Becky Sharp: she's going too</span>."</p><p>"<span data-begin="376.240" data-dur="14.200">MISS JEMIMA!" exclaimed Miss Pinkerton, in the largest capitals. "Are you in your senses? Replace the Dixonary in the closet, and never venture to take such a liberty in future</span>."</p><p>"<span data-begin="390.440" data-dur="7.040">Well, sister, it's only two-and-ninepence, and poor Becky will be miserable if she don't get one</span>."</p><p>"<span data-begin="397.480" data-dur="11.240">Send Miss Sedley instantly to me," said Miss Pinkerton. And so venturing not to say another word, poor Jemima trotted off, exceedingly flurried and nervous</span>.</p><p><span data-begin="408.760" data-dur="16.880">Miss Sedley's papa was a merchant in London, and a man of some wealth; whereas Miss Sharp was an articled pupil, for whom Miss Pinkerton had done, as she thought, quite enough, without conferring upon her at parting the high honour of the Dixonary</span>.</p><p><span data-begin="425.640" data-dur="52.200">Although schoolmistresses' letters are to be trusted no more nor less than churchyard epitaphs; yet, as it sometimes happens that a person departs this life who is really deserving of all the praises the stone cutter carves over his bones; who IS a good Christian, a good parent, child, wife, or husband; who actually DOES leave a disconsolate family to mourn his loss; so in academies of the male and female sex it occurs every now and then that the pupil is fully worthy of the praises bestowed by the disinterested instructor. Now, Miss Amelia Sedley was a young lady of this singular species; and deserved not only all that Miss Pinkerton said in her praise, but had many charming qualities which that pompous old Minerva of a woman could not see, from the differences of rank and age between her pupil and herself</span>.</p><p><span data-begin="477.880" data-dur="111.120">For she could not only sing like a lark, or a Mrs. Billington, and dance like Hillisberg or Parisot; and embroider beautifully; and spell as well as a Dixonary itself; but she had such a kindly, smiling, tender, gentle, generous heart of her own, as won the love of everybody who came near her, from Minerva herself down to the poor girl in the scullery, and the one-eyed tart-woman's daughter, who was permitted to vend her wares once a week to the young ladies in the Mall. She had twelve intimate and bosom friends out of the twenty-four young ladies. Even envious Miss Briggs never spoke ill of her; high and mighty Miss Saltire (Lord Dexter's granddaughter) allowed that her figure was genteel; and as for Miss Swartz, the rich woolly-haired mulatto from St. Kitt's, on the day Amelia went away, she was in such a passion of tears that they were obliged to send for Dr. Floss, and half tipsify her with salvolatile. Miss Pinkerton's attachment was, as may be supposed from the high position and eminent virtues of that lady, calm and dignified; but Miss Jemima had already whimpered several times at the idea of Amelia's departure; and, but for fear of her sister, would have gone off in downright hysterics, like the heiress (who paid double) of St. Kitt's. Such luxury of grief, however, is only allowed to parlour-boarders. Honest Jemima had all the bills, and the washing, and the mending, and the puddings, and the plate and crockery, and the servants to superintend. But why speak about her? It is probable that we shall not hear of her again from this moment to the end of time, and that when the great filigree iron gates are once closed on her, she and her awful sister will never issue therefrom into this little world of history</span>.</p><p><span data-begin="589.000" data-dur="90.440">But as we are to see a great deal of Amelia, there is no harm in saying, at the outset of our acquaintance, that she was a dear little creature; and a great mercy it is, both in life and in novels, which (and the latter especially) abound in villains of the most sombre sort, that we are to have for a constant companion so guileless and good-natured a person. As she is not a heroine, there is no need to describe her person; indeed I am afraid that her nose was rather short than otherwise, and her cheeks a great deal too round and red for a heroine; but her face blushed with rosy health, and her lips with the freshest of smiles, and she had a pair of eyes which sparkled with the brightest and honestest good-humour, except indeed when they filled with tears, and that was a great deal too often; for the silly thing would cry over a dead canary-bird; or over a mouse, that the cat haply had seized upon; or over the end of a novel, were it ever so stupid; and as for saying an unkind word to her, were any persons hard-hearted enough to do so—why, so much the worse for them. Even Miss Pinkerton, that austere and godlike woman, ceased scolding her after the first time, and though she no more comprehended sensibility than she did Algebra, gave all masters and teachers particular orders to treat Miss Sedley with the utmost gentleness, as harsh treatment was injurious to her</span>.</p><p><span data-begin="679.440" data-dur="94.720">So that when the day of departure came, between her two customs of laughing and crying, Miss Sedley was greatly puzzled how to act. She was glad to go home, and yet most woefully sad at leaving school. For three days before, little Laura Martin, the orphan, followed her about like a little dog. She had to make and receive at least fourteen presents—to make fourteen solemn promises of writing every week: "Send my letters under cover to my grandpapa, the Earl of Dexter," said Miss Saltire (who, by the way, was rather shabby). "Never mind the postage, but write every day, you dear darling," said the impetuous and woolly-headed, but generous and affectionate Miss Swartz; and the orphan little Laura Martin (who was just in round-hand), took her friend's hand and said, looking up in her face wistfully, "Amelia, when I write to you I shall call you Mamma." All which details, I have no doubt, JONES, who reads this book at his Club, will pronounce to be excessively foolish, trivial, twaddling, and ultra-sentimental. Yes; I can see Jones at this minute (rather flushed with his joint of mutton and half pint of wine), taking out his pencil and scoring under the words "foolish, twaddling," &c., and adding to them his own remark of "QUITE TRUE." Well, he is a lofty man of genius, and admires the great and heroic in life and novels; and so had better take warning and go elsewhere</span>.</p><p><span data-begin="774.160" data-dur="65.640">Well, then. The flowers, and the presents, and the trunks, and bonnet-boxes of Miss Sedley having been arranged by Mr. Sambo in the carriage, together with a very small and weather-beaten old cow's-skin trunk with Miss Sharp's card neatly nailed upon it, which was delivered by Sambo with a grin, and packed by the coachman with a corresponding sneer—the hour for parting came; and the grief of that moment was considerably lessened by the admirable discourse which Miss Pinkerton addressed to her pupil. Not that the parting speech caused Amelia to philosophise, or that it armed her in any way with a calmness, the result of argument; but it was intolerably dull, pompous, and tedious; and having the fear of her schoolmistress greatly before her eyes, Miss Sedley did not venture, in her presence, to give way to any ebullitions of private grief. A seed-cake and a bottle of wine were produced in the drawing-room, as on the solemn occasions of the visits of parents, and these refreshments being partaken of, Miss Sedley was at liberty to depart</span>.</p><p>"<span data-begin="839.800" data-dur="11.880">You'll go in and say good-by to Miss Pinkerton, Becky!" said Miss Jemima to a young lady of whom nobody took any notice, and who was coming downstairs with her own bandbox</span>.</p><p>"<span data-begin="851.720" data-dur="21.040">I suppose I must," said Miss Sharp calmly, and much to the wonder of Miss Jemima; and the latter having knocked at the door, and receiving permission to come in, Miss Sharp advanced in a very unconcerned manner, and said in French, and with a perfect accent, "Mademoiselle, je viens vous faire mes adieux</span>."</p><p><span data-begin="872.760" data-dur="30.920">Miss Pinkerton did not understand French; she only directed those who did: but biting her lips and throwing up her venerable and Roman-nosed head (on the top of which figured a large and solemn turban), she said, "Miss Sharp, I wish you a good morning." As the Hammersmith Semiramis spoke, she waved one hand, both by way of adieu, and to give Miss Sharp an opportunity of shaking one of the fingers of the hand which was left out for that purpose</span>.</p><p><span data-begin="904.520" data-dur="37.320">Miss Sharp only folded her own hands with a very frigid smile and bow, and quite declined to accept the proffered honour; on which Semiramis tossed up her turban more indignantly than ever. In fact, it was a little battle between the young lady and the old one, and the latter was worsted. "Heaven bless you, my child," said she, embracing Amelia, and scowling the while over the girl's shoulder at Miss Sharp. "Come away, Becky," said Miss Jemima, pulling the young woman away in great alarm, and the drawing-room door closed upon them for ever</span>.</p><p><span data-begin="941.840" data-dur="40.520">Then came the struggle and parting below. Words refuse to tell it. All the servants were there in the hall—all the dear friend—all the young ladies—the dancing-master who had just arrived; and there was such a scuffling, and hugging, and kissing, and crying, with the hysterical YOOPS of Miss Swartz, the parlour-boarder, from her room, as no pen can depict, and as the tender heart would fain pass over. The embracing was over; they parted—that is, Miss Sedley parted from her friends. Miss Sharp had demurely entered the carriage some minutes before. Nobody cried for leaving HER</span>.</p><p><span data-begin="982.360" data-dur="11.720">Sambo of the bandy legs slammed the carriage door on his young weeping mistress. He sprang up behind the carriage. "Stop!" cried Miss Jemima, rushing to the gate with a parcel</span>.</p><p>"<span data-begin="994.080" data-dur="19.600">It's some sandwiches, my dear," said she to Amelia. "You may be hungry, you know; and Becky, Becky Sharp, here's a book for you that my sister—that is, I—Johnson's Dixonary, you know; you mustn't leave us without that. Good-by. Drive on, coachman. God bless you</span>!"</p><p><span data-begin="1014.240" data-dur="4.360">And the kind creature retreated into the garden, overcome with emotion</span>.</p><p><span data-begin="1018.600" data-dur="10.160">But, lo! and just as the coach drove off, Miss Sharp put her pale face out of the window and actually flung the book back into the garden</span>.</p><p><span data-begin="1028.760" data-dur="28.200">This almost caused Jemima to faint with terror. "Well, I never"—said she—"what an audacious"—Emotion prevented her from completing either sentence. The carriage rolled away; the great gates were closed; the bell rang for the dancing lesson. The world is before the two young ladies; and so, farewell to Chiswick Mall</span>.</p>
            </div>

        </article>

        <footer class="credits">
            <p>阅读外语经典，了解世界文化，复兴中华文明</p>
            <p>听语族外语软件工作室出品 湖南长沙 联系人：李涉川 微信 Tingyuzu.</p>
        </footer>

    </body>
<script type="text/javascript">
/**
 * HTML5 Audio Read-Along
 * @author Weston Ruter, X-Team
 * @license MIT/GPL
 * https://github.com/westonruter/html5-audio-read-along
 */
var ReadAlong = {
    text_element: null,
    audio_element: null,
    autofocus_current_word: true,

    words: [],

    init: function (args) {
        var name;
        for (name in args) {
            this[name] = args[name];
        }
        this.generateWordList();
        this.addEventListeners();
        this.selectCurrentWord();
    },

    /**
     * Build an index of all of the words that can be read along with their begin,
     * and end times, and the DOM element representing the word.
     */
    generateWordList: function () {
        var word_els = this.text_element.querySelectorAll('[data-begin]');
        this.words = Array.prototype.map.call(word_els, function (word_el, index) {
            var word = {
                'begin': parseFloat(word_el.dataset.begin),
                'dur': parseFloat(word_el.dataset.dur),
                'element': word_el
            };
            word_el.tabIndex = 0; // to make it focusable/interactive
            word.index = index;
            word.end = word.begin + word.dur;
            word_el.dataset.index = word.index;
            return word;
        });
    },

    /**
     * From the audio's currentTime, find the word that is currently being played
     * @todo this would better be implemented as a binary search
     */
    getCurrentWord: function () {
        var i;
        var len;
        var is_current_word;
        var word = null;
        for (i = 0, len = this.words.length; i < len; i += 1) {
            is_current_word = (
                (
                    this.audio_element.currentTime >= this.words[i].begin
                    &&
                    this.audio_element.currentTime < this.words[i].end
                )
                ||
                (this.audio_element.currentTime < this.words[i].begin)
            );
            if (is_current_word) {
                word = this.words[i];
                break;
            }
        }

        if (!word) {
            throw Error('Unable to find current word and we should always be able to.');
        }
        return word;
    },

    _current_end_select_timeout_id: null,
    _current_next_select_timeout_id: null,

    /**
     * Select the current word and set timeout to select the next one if playing
     */
    selectCurrentWord: function() {
        var that = this;
        var current_word = this.getCurrentWord();
        var is_playing = !this.audio_element.paused;

        if (!current_word.element.classList.contains('speaking')) {
            this.removeWordSelection();
            current_word.element.classList.add('speaking');
            if (this.autofocus_current_word) {
                current_word.element.focus();
            }
        }

        /**
         * The timeupdate Media event does not fire repeatedly enough to be
         * able to rely on for updating the selected word (it hovers around
         * 250ms resolution), so we add a setTimeout with the exact duration
         * of the word.
         */
        if (is_playing) {
            // Remove word selection when the word ceases to be spoken
            var seconds_until_this_word_ends = current_word.end - this.audio_element.currentTime; // Note: 'word' not 'world'! ;-)
            if (typeof this.audio_element === 'number' && !isNaN(this.audio_element)) {
                seconds_until_this_word_ends *= 1.0/this.audio_element.playbackRate;
            }
            clearTimeout(this._current_end_select_timeout_id);
            this._current_end_select_timeout_id = setTimeout(
                function () {
                    if (!that.audio_element.paused) { // we always want to have a word selected while paused
                        current_word.element.classList.remove('speaking');
                    }
                },
                Math.max(seconds_until_this_word_ends * 1000, 0)
            );

            // Automatically trigger selectCurrentWord when the next word begins
            var next_word = this.words[current_word.index + 1];
            if (next_word) {
                var seconds_until_next_word_begins = next_word.begin - this.audio_element.currentTime;

                var orig_seconds_until_next_word_begins = seconds_until_next_word_begins; // temp
                if (typeof this.audio_element === 'number' && !isNaN(this.audio_element)) {
                    seconds_until_next_word_begins *= 1.0/this.audio_element.playbackRate;
                }
                clearTimeout(this._current_next_select_timeout_id);
                this._current_next_select_timeout_id = setTimeout(
                    function () {
                        that.selectCurrentWord();
                    },
                    Math.max(seconds_until_next_word_begins * 1000, 0)
                );
            }
        }

    },

    removeWordSelection: function() {
        // There should only be one element with .speaking, but selecting all for good measure
        var spoken_word_els = this.text_element.querySelectorAll('span[data-begin].speaking');
        Array.prototype.forEach.call(spoken_word_els, function (spoken_word_el) {
            spoken_word_el.classList.remove('speaking');
        });
    },


    addEventListeners: function () {
        var that = this;

        /**
         * Select next word (at that.audio_element.currentTime) when playing begins
         */
        that.audio_element.addEventListener('play', function (e) {
            that.selectCurrentWord();
            that.text_element.classList.add('speaking');
        }, false);

        /**
         * Abandon seeking the next word because we're paused
         */
        that.audio_element.addEventListener('pause', function (e) {
            that.selectCurrentWord(); // We always want a word to be selected
            that.text_element.classList.remove('speaking');
        }, false);

        /**
         * Seek by selecting a word (event delegation)
         */
        function on_select_word_el(e) {
            if (!e.target.dataset.begin) {
                return;
            }
            e.preventDefault();

            var i = e.target.dataset.index;
            that.audio_element.currentTime = that.words[i].begin + 0.01; //Note: times apparently cannot be exactly set and sometimes select too early
            that.selectCurrentWord();
        }
        that.text_element.addEventListener('click', on_select_word_el, false);
        that.text_element.addEventListener('keypress', function (e) {
            if ( (e.charCode || e.keyCode) === 13 /*Enter*/) {
                on_select_word_el.call(this, e);
            }
        }, false);

        /**
         * Spacebar toggles playback
         */
        document.addEventListener('keypress', function (e) {
            if ( (e.charCode || e.keyCode) === 32 /*Space*/) {
                e.preventDefault();
                if (that.audio_element.paused) {
                    that.audio_element.play();
                }
                else {
                    that.audio_element.pause();
                }
            }
        }, false);

        /**
         * First click handler sets currentTime to the word, and second click
         * here then causes it to play.
         * @todo Should it stop playing once the duration is over?
         */
        that.text_element.addEventListener('dblclick', function (e) {
            e.preventDefault();
            that.audio_element.play();
        }, false);

        /**
         * Select a word when seeking
         */
        that.audio_element.addEventListener('seeked', function (e) {
            that.selectCurrentWord();

            /**
             * Address probem with Chrome where sometimes it seems to get stuck upon seeked:
             * http://code.google.com/p/chromium/issues/detail?id=99749
             */
            var audio_element = this;
            if (!audio_element.paused) {
                var previousTime = audio_element.currentTime;
                setTimeout(function () {
                    if (!audio_element.paused && previousTime === audio_element.currentTime) {
                        audio_element.currentTime += 0.01; // Attempt to unstick
                    }
                }, 500);
            }
        }, false);

        /**
         * Select a word when seeking
         */
        that.audio_element.addEventListener('ratechange', function (e) {
            that.selectCurrentWord();
        }, false);
    }
};
</script>
<script type="text/javascript">
/*global ReadAlong */
window.addEventListener('load', function (e) {
    try {
        var args = {
            text_element: document.getElementById('passage-text'),
            audio_element: document.getElementById('passage-audio'),
            autofocus_current_word: document.getElementById('autofocus-current-word').checked
        };

        if (!args.audio_element.canPlayType) {
            // No error messaging is needed because error message appears in <audio> fallback
            throw new Error('HTML5 Audio not supported');
        }
        if (args.audio_element.networkState === args.audio_element.NETWORK_NO_SOURCE) {
            document.querySelector('.passage-audio-unavailable').hidden = false;
            throw new Error('Cannot play any of the available sources');
        }

        var supports_playback_rate = (function (audio) {
            if (typeof audio.playbackRate !== 'number' || isNaN(audio.playbackRate)) {
                return false;
            }

            // For Opera, since it doesn't currently support playbackRate and yet
            // has it defined as 1.0, we can detect Opera support by changing
            // the playbackRate and see if the change sticks.
            var original_playback_rate = audio.playbackRate;
            audio.playbackRate += 1.0;
            var is_playback_rate_changed = (original_playback_rate !== audio.playbackRate);
            audio.playbackRate = original_playback_rate;
            return is_playback_rate_changed;
        }(args.audio_element));

        if (supports_playback_rate) {
            var rate_range_element = document.getElementById('playback-rate');
            rate_range_element.disabled = false;
            rate_range_element.addEventListener('change', function (e) {
                args.audio_element.playbackRate = this.valueAsNumber;
            }, false);
        }
        else {
            document.querySelector('.playback-rate-unavailable').hidden = false;
        }

        ReadAlong.init(args);

        document.getElementById('autofocus-current-word').addEventListener('change', function (e) {
            ReadAlong.autofocus_current_word = this.checked;
        }, false);

        document.querySelector('.passage-audio').hidden = false;
        if (supports_playback_rate) {
            document.querySelector('.playback-rate').hidden = false;
        }
        document.querySelector('.autofocus-current-word').hidden = false;
    }
    catch (err) {
        console.error(err);
    }
    document.body.classList.add('initialized');
    document.querySelector('.loading').hidden = true;
}, false);
</script>
</html>
